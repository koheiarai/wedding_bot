{"filter":false,"title":"send-request.js","tooltip":"/src/lib/http/send-request.js","undoManager":{"mark":15,"position":15,"stack":[[{"start":{"row":0,"column":0},"end":{"row":51,"column":0},"action":"insert","lines":["'use strict';","","const request = require('request');","const SmartResponse = require(__base + 'lib/http/smart-response');","const Time = require(__base + 'lib/utils/time');","const Logger = require(__base + 'lib/utils/logger');","","// TODO: process.env.MAX_RETRIESを追加","// TODO: process.env.NO_RETRY_STATUS_CODEを追加","// TODO: process.env.RETRY_INTERVAL_MSECを追加","const maxReries = (process.env.MAX_RETRIES || 5) + 1;","const noRetryStatusCode = process.env.NO_RETRY_STATUS_CODE || 0;","const retryIntervalMSec = process.env.RETRY_INTERVAL_MSEC || 3000;","","/**"," * リクエストを送信する。"," * statuscodeが200番台以外の場合にはリトライを行う。"," * @param {options} options"," */","function *sendRequest(options) {","    let response = null;","    for (let i = 0; i < maxReries; i++) {","        if (i > 0) {","            yield Time.timeSleep(retryIntervalMSec);","        }","        response = yield _request(options);","        let code = response.getStatusCode();","        Logger.debug(\"status code: \" + code);","        //statuscodeが呼び出し元によって指定された番号もしくは、500番台以外の場合はリトライしない","        if (code === noRetryStatusCode || code < 500) {","            break;","        }","    }","    return response;","}","","function _request(options) {","    const stack = (new Error().stack);","    Logger.debug(\"Options: \" + JSON.stringify(options));","    return new Promise((resolve, reject) => {","        request(options, (error, response, body) => {","            if (error) {","                reject(`${stack}\\n${error.stack}\\noptions: ${JSON.stringify(options)}\\nbody: ${JSON.stringify(body)}`);","                return;","            }","            resolve(new SmartResponse(body, response, options)); // リスポンスを返す","        });","    });","}","","module.exports = sendRequest;",""],"id":11}],[{"start":{"row":3,"column":40},"end":{"row":3,"column":43},"action":"remove","lines":["lib"],"id":12},{"start":{"row":3,"column":40},"end":{"row":3,"column":41},"action":"insert","lines":["h"]}],[{"start":{"row":3,"column":41},"end":{"row":3,"column":42},"action":"insert","lines":["t"],"id":13}],[{"start":{"row":3,"column":42},"end":{"row":3,"column":43},"action":"insert","lines":["t"],"id":14}],[{"start":{"row":3,"column":43},"end":{"row":3,"column":44},"action":"insert","lines":["p"],"id":15}],[{"start":{"row":3,"column":40},"end":{"row":3,"column":45},"action":"remove","lines":["http/"],"id":16}],[{"start":{"row":4,"column":0},"end":{"row":6,"column":0},"action":"remove","lines":["const Time = require(__base + 'lib/utils/time');","const Logger = require(__base + 'lib/utils/logger');",""],"id":17}],[{"start":{"row":20,"column":8},"end":{"row":20,"column":11},"action":"insert","lines":["// "],"id":18},{"start":{"row":21,"column":8},"end":{"row":21,"column":11},"action":"insert","lines":["// "]},{"start":{"row":22,"column":8},"end":{"row":22,"column":11},"action":"insert","lines":["// "]}],[{"start":{"row":25,"column":8},"end":{"row":25,"column":11},"action":"insert","lines":["// "],"id":19}],[{"start":{"row":36,"column":4},"end":{"row":36,"column":7},"action":"insert","lines":["// "],"id":20}],[{"start":{"row":3,"column":0},"end":{"row":3,"column":3},"action":"insert","lines":["// "],"id":21}],[{"start":{"row":33,"column":0},"end":{"row":46,"column":0},"action":"insert","lines":["// Http request","function _request(options) {","    const stack = (new Error().stack);","    return new Promise((resolve, reject) => {","        request(options, (error, response, body) => {","            if (error) {","                reject(`${stack}\\n${error.stack}\\noptions: ${JSON.stringify(options)}\\nbody: ${JSON.stringify(body)}`);","                return;","            }","            resolve(response); // リスポンスを返す","        });","    });","}",""],"id":22}],[{"start":{"row":47,"column":0},"end":{"row":47,"column":3},"action":"insert","lines":["// "],"id":23},{"start":{"row":48,"column":0},"end":{"row":48,"column":3},"action":"insert","lines":["// "]},{"start":{"row":49,"column":0},"end":{"row":49,"column":3},"action":"insert","lines":["// "]},{"start":{"row":50,"column":0},"end":{"row":50,"column":3},"action":"insert","lines":["// "]},{"start":{"row":51,"column":0},"end":{"row":51,"column":3},"action":"insert","lines":["// "]},{"start":{"row":52,"column":0},"end":{"row":52,"column":3},"action":"insert","lines":["// "]},{"start":{"row":53,"column":0},"end":{"row":53,"column":3},"action":"insert","lines":["// "]},{"start":{"row":54,"column":0},"end":{"row":54,"column":3},"action":"insert","lines":["// "]},{"start":{"row":55,"column":0},"end":{"row":55,"column":3},"action":"insert","lines":["// "]},{"start":{"row":56,"column":0},"end":{"row":56,"column":3},"action":"insert","lines":["// "]},{"start":{"row":57,"column":0},"end":{"row":57,"column":3},"action":"insert","lines":["// "]},{"start":{"row":58,"column":0},"end":{"row":58,"column":3},"action":"insert","lines":["// "]},{"start":{"row":59,"column":0},"end":{"row":59,"column":3},"action":"insert","lines":["// "]}],[{"start":{"row":17,"column":0},"end":{"row":17,"column":3},"action":"insert","lines":["// "],"id":24},{"start":{"row":18,"column":0},"end":{"row":18,"column":3},"action":"insert","lines":["// "]},{"start":{"row":19,"column":0},"end":{"row":19,"column":3},"action":"insert","lines":["// "]},{"start":{"row":20,"column":0},"end":{"row":20,"column":3},"action":"insert","lines":["// "]},{"start":{"row":21,"column":0},"end":{"row":21,"column":3},"action":"insert","lines":["// "]},{"start":{"row":22,"column":0},"end":{"row":22,"column":3},"action":"insert","lines":["// "]},{"start":{"row":23,"column":0},"end":{"row":23,"column":3},"action":"insert","lines":["// "]},{"start":{"row":24,"column":0},"end":{"row":24,"column":3},"action":"insert","lines":["// "]},{"start":{"row":25,"column":0},"end":{"row":25,"column":3},"action":"insert","lines":["// "]},{"start":{"row":26,"column":0},"end":{"row":26,"column":3},"action":"insert","lines":["// "]},{"start":{"row":27,"column":0},"end":{"row":27,"column":3},"action":"insert","lines":["// "]},{"start":{"row":28,"column":0},"end":{"row":28,"column":3},"action":"insert","lines":["// "]},{"start":{"row":29,"column":0},"end":{"row":29,"column":3},"action":"insert","lines":["// "]},{"start":{"row":30,"column":0},"end":{"row":30,"column":3},"action":"insert","lines":["// "]},{"start":{"row":31,"column":0},"end":{"row":31,"column":3},"action":"insert","lines":["// "]},{"start":{"row":32,"column":0},"end":{"row":32,"column":3},"action":"insert","lines":["// "]}],[{"start":{"row":61,"column":17},"end":{"row":61,"column":22},"action":"remove","lines":["sendR"],"id":25},{"start":{"row":61,"column":17},"end":{"row":61,"column":18},"action":"insert","lines":["_"]}],[{"start":{"row":61,"column":18},"end":{"row":61,"column":19},"action":"insert","lines":["r"],"id":26}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":35,"column":38},"end":{"row":35,"column":38},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":133,"mode":"ace/mode/javascript"}},"timestamp":1521717963419,"hash":"69e9024203e73363c1aa2c808a562149f9246deb"}